{% extends "layout.html" %} {% block title %}Journal{% endblock %} {% block body
%}
<div class="container pt-4 pb-2">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">Journal</h1>
    <a href="/journal/new" class="btn btn-primary">New Entry</a>
  </div>

  <div class="journal-feed">
    {% for entry in entries %}
    <div class="journal-entry-card" data-entry-id="{{ entry.id }}">
      <div class="journal-entry-header">
        <div class="journal-entry-meta">
          <p class="journal-entry-date">
            <span class="date-icon">ğŸ“…</span>
            {{ entry.date.strftime("%B %d, %Y") }}
          </p>
          <span class="journal-mood-badge mood-{{ entry.mood.lower() }}"
            >{{ entry.mood }}</span
          >
        </div>
        <div class="entry-actions">
          <a
            href="/journal/edit/{{ entry.id }}"
            class="btn btn-sm btn-outline-primary mr-2"
            title="Edit entry"
            >âœï¸ Edit</a
          >
          <button
            class="btn btn-sm btn-outline-danger entry-del"
            data-entry-id="{{ entry.id }}"
            title="Delete entry"
          >
            ğŸ—‘ï¸ Delete
          </button>
        </div>
      </div>
      <div class="journal-entry-body">
        <div class="prompt-section">
          <div class="prompt-icon">ğŸ’­</div>
          <div class="prompt-text">{{ entry.prompt }}</div>
        </div>
        <div class="entry-preview">
          <p class="entry-content-preview">
            {{ entry.content[:150] }}{% if entry.content|length > 150 %}...{%
            endif %}
          </p>
          {% if entry.content|length > 150 %}
          <span class="read-more-link">Click to read more â†’</span>
          {% endif %}
        </div>
      </div>
    </div>
    {% else %}
    <div class="text-center py-5 empty-journal">
      <div class="empty-icon">ğŸ“”</div>
      <p class="text-muted mt-3">
        No entries yet. Start your journaling journey!
      </p>
      <a href="/journal/new" class="btn btn-primary mt-2"
        >Create Your First Entry</a
      >
    </div>
    {% endfor %}
  </div>
</div>

<!-- Modal for viewing full entry -->
<div
  class="modal fade"
  id="entryModal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="entryModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="entryModalLabel">
          <span id="modal-date"></span>
          <span id="modal-mood" class="ml-2"></span>
        </h5>
        <button
          type="button"
          class="close"
          data-dismiss="modal"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="modal-prompt-section mb-3">
          <strong>ğŸ’­ Prompt:</strong>
          <p id="modal-prompt" class="mt-2"></p>
        </div>
        <div class="modal-content-section">
          <strong>ğŸ“ Your Entry:</strong>
          <p id="modal-content" class="mt-2"></p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          Close
        </button>
        <a id="modal-edit-link" href="#" class="btn btn-primary">Edit Entry</a>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Wait for DOM and jQuery to be ready
  $(document).ready(function() {
    // Store entry data
    const entryData = {
      {% for entry in entries %}
      {{ entry.id }}: {
        date: "{{ entry.date.strftime('%B %d, %Y') }}",
        mood: "{{ entry.mood }}",
        prompt: {{ entry.prompt|tojson }},
        content: {{ entry.content|tojson }}
      }{% if not loop.last %},{% endif %}
      {% endfor %}
    };

    // Handle card clicks to show full entry
    $(".journal-entry-card").on("click", function(e) {
      const $card = $(this);
      const $target = $(e.target);

      // Don't trigger if clicking on action buttons, links, or inside entry-actions
      if ($target.closest(".entry-actions").length > 0) {
        e.stopPropagation();
        return;
      }

      // Don't trigger on direct clicks on buttons or links
      if ($target.is("a, button") || $target.closest("a, button").length > 0) {
        return;
      }

      const entryId = $card.attr("data-entry-id");
      const entry = entryData[entryId];

      if (entry) {
        $("#modal-date").text(entry.date);
        $("#modal-mood").text(entry.mood);
        $("#modal-mood").removeClass().addClass("ml-2 journal-mood-badge mood-" + entry.mood.toLowerCase().replace(/\s+/g, '-'));
        $("#modal-prompt").text(entry.prompt);
        $("#modal-content").text(entry.content).css("white-space", "pre-wrap");
        $("#modal-edit-link").attr("href", "/journal/edit/" + entryId);

        $("#entryModal").modal("show");
      }
    });

    // Handle delete button clicks
    $(".entry-del").on("click", function(e) {
      e.stopPropagation();
      e.preventDefault();
      const btn = $(this);
      const entryId = btn.attr("data-entry-id") || btn.data("entry-id");

      if (confirm("Are you sure you want to delete this entry?")) {
        fetch(`/journal/delete/${entryId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.success) {
              // Remove the card with animation
              const card = btn.closest(".journal-entry-card");
              card.css({
                "transition": "opacity 0.3s, transform 0.3s",
                "opacity": "0",
                "transform": "scale(0.95)"
              });
              setTimeout(function() {
                card.remove();
                // Remove from entryData
                delete entryData[entryId];
              }, 300);
            } else {
              alert("Failed to delete entry. Please try again.");
            }
          })
          .catch(function(error) {
            console.error("Error deleting entry:", error);
            alert("An error occurred while deleting the entry.");
          });
      }
    });
  });
</script>
{% endblock %}
